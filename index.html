<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.css' rel='stylesheet' />
    <script
            src="https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"
            charset="utf-8"
    ></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        #map {
            position: relative;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 800px;
            text-align: center!important;
        }
        #marker {
            background-image: url('marker.png');
            background-size: cover;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .mapboxgl-popup {
            max-width: 200px;
        }

        .responsiveimg {
          max-width: 100%;
          height: auto;
        }

        #menu {
            position: absolute;
            z-index: 1;
            top: 10px;
            letf: 10px;
            width: 120px;
        }

        #semaineSelect {
            background-color: #e34a00;
            border-color: #e34a00;
            color: #ffffff;
        }
    </style>
</head>
<body>
<div class="row">
    <div class="col text-center mb-1">
        <img src="header.jpg" class="responsiveimg">
    </div>
</div>
<div class="row">
    <div class="col text-center">
        <nav id="menu">
            <select name="semaine" id="semaineSelect" onchange="changeSemaine(this.value)">
                <option value="s_1">semaine 1</option>
                <option value="s_2">semaine 2</option>
            </select>
        </nav>
        <div id="map"></div>
    </div>
</div>
<script>

    /*
    https://api.mapbox.com/directions/v5/mapbox/driving/3.4388069189074537%2C43.62408939627776%3B3.86394%2C43.576061%3B3.800452%2C43.466173?alternatives=false&geometries=geojson&steps=false&access_token=pk.eyJ1Ijoibm9icnV4IiwiYSI6ImNqbXoyaDRuYTE3ODUza3FsbjVqNmZjeGUifQ.ZiVsjOx7jgEda1jznEeBUA
    */
    mapboxgl.accessToken = window.atob('cGsuZXlKMUlqb2libTlpY25WNElpd2lZU0k2SW1OcWJYb3lhRFJ1WVRFM09EVXphM0ZzYmpWcU5tWmplR1VpZlEuWmlWc2pPeDdqZ0VkYTFqem5FZUJVQQ==');
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v10',
        center: [6.127822,45.900026], // starting position
        zoom: 5
    });

    map.addControl(new mapboxgl.NavigationControl());
    var canvas = map.getCanvasContainer();
    var route;
    var geojson;
    var distHtmlMarker;
    var distMarker;

    $( document ).ready(function() {
        $("#semaineSelect").hide();
    });

    function changeSemaine(pSemaine){
        if(pSemaine == "s_1") {
            addMarker(4244 , "07/06/2020" , "21h");
        } else if(pSemaine == "s_2") {
            addMarker(4212, "14/06/2020" , "21h");
        }
    }

    function addMarker(pDistance , pDate, pHeure) {
        let distance = pDistance;//4244;
        let along = turf.along(geojson, distance , 'kilometers');
        let pLat = along.geometry.coordinates[0];
        let pLong = along.geometry.coordinates[1];

        var popup = new mapboxgl.Popup({ offset: 25 , closeOnClick: false, closeButton: false }).setHTML(
            pDistance+ ' km parcourus<br>au '+pDate+' Ã  '+pHeure
        );

        if(distMarker){
            distMarker.remove();
        }
        distHtmlMarker = document.createElement('div');
        distHtmlMarker.id = 'marker';

        distMarker = new mapboxgl.Marker(distHtmlMarker)
            .setLngLat([pLat, pLong])
            .setPopup(popup) // sets a popup on this marker
            .addTo(map)
            .togglePopup();
    }
   
    function getRoute() {
        //var url = 'https://api.mapbox.com/directions/v5/mapbox/driving/6.127822%2C45.900026%3B5.066299%2C47.322268%3B7.734054%2C48.576372%3B6.192091%2C48.687013%3B4.015424%2C49.229013%3B3.03702%2C50.611911%3B1.111598%2C49.438808%3B-0.356648%2C49.205727%3B-4.486606%2C48.392479%3B-1.578501%2C47.228237%3B0.385495%2C46.559104%3B-0.604375%2C44.830764%3B1.437794%2C43.599678%3B3.849075%2C43.631439%3B5.401651%2C43.298909%3B7.283044%2C43.724534%3B6.869947%2C45.923774?alternatives=false&geometries=geojson&steps=false&access_token=' + mapboxgl.accessToken;
        let url = 'https://api.mapbox.com/directions/v5/mapbox/driving/6.127822%2C45.900026%3B5.066299%2C47.322268%3B7.734054%2C48.576372%3B6.192091%2C48.687013%3B4.015424%2C49.229013%3B3.03702%2C50.611911%3B1.867928%2C50.954254%3B1.111598%2C49.438808%3B-0.356648%2C49.205727%3B-4.486606%2C48.392479%3B-1.578501%2C47.228237%3B0.385495%2C46.559104%3B-0.604375%2C44.830764%3B-1.549699%2C43.470168%3B1.437794%2C43.599678%3B3.849075%2C43.631439%3B5.401651%2C43.298909%3B7.283044%2C43.724534%3B6.869947%2C45.923774?alternatives=false&geometries=geojson&steps=false&access_token=' + mapboxgl.accessToken;
        let req = new XMLHttpRequest();
        req.open('GET', url, true);
        req.onload = function() {
            let json = JSON.parse(req.response);
            let data = json.routes[0];
            route = data.geometry.coordinates;
            geojson = {
                type: 'Feature',
                properties: {},
                geometry: {
                    type: 'LineString',
                    coordinates: route
                }
            };

                let baproute = map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: {
                        type: 'geojson',
                        data: geojson
                    },
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#3887be',
                        'line-width': 5,
                        'line-opacity': 0.75
                    }
                });

            //let distance = 4244;
            //let along = turf.along(geojson, distance , 'kilometers');
            //addMarker(along.geometry.coordinates[0],along.geometry.coordinates[1],distance);
            $("#semaineSelect").show();
            $("#semaineSelect").val('s_2');
            addMarker(4212, "14/06/2020" , "21h");

            let markerdebut = new mapboxgl.Marker()
                        .setLngLat(route[0])
                        .addTo(map);

            let markerfin = new mapboxgl.Marker()
                        .setLngLat(route[route.length -1])
                        .addTo(map)

        };
        req.send();
    }

    map.on('load', function() {
        getRoute();
    });
</script>

</body>
</html>
